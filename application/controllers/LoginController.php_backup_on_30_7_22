<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class LoginController extends CI_Controller {
	public function __construct()
	{
		parent::__construct();
		$this->load->library('session');
		$this->load->library('form_validation');
		$this->load->helper(array('form', 'url','security'));
		$this->db = $this->load->database('db2',TRUE);
		$this->dbb = $this->load->database('auth', true);
                ini_set('memory_limit','-1');
                set_time_limit(0);
	}


	// generate random Salt (string)
	function randomSalt($len = 11)
	{
	    $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-=_+';
	    $l = strlen($chars) - 1;
	    $str = '';
	    for ($i = 0; $i<$len; ++$i)
	    {
	        $str .= $chars[rand(0, $l)];
	    }
	    $pass = password_hash($str, PASSWORD_BCRYPT);
	    return substr($pass,0,29);
	}


	public function index()
	{
		$ranKey = $this->randomSalt(11);
    	$this->session->set_userdata('randomKey', $ranKey);

		if($this->session->userdata('logged_in') == TRUE){
			redirect('dashboard');
		}

		if($this->session->has_userdata('captcha'))
		{
			$this->session->unset_userdata('captcha');
		}

		$pool = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
		$captcha = substr(str_shuffle(str_repeat($pool, 6)), 0, 6);
		$newdata = array(
			'captcha'  => $captcha
		);
		$this->session->set_userdata($newdata);



		$data['captcha'] = $captcha;
		$this->load->view('login/login');
	}

	//********* LOG OUT ************//
	public function logout() {
		$this->get_client_exit();
		$this->session->sess_destroy();
		session_destroy();
		$newdata = array(
			'logged_in'  => false
		);
		$this->session->set_userdata($newdata);
		redirect('login');
	}

	//********** LOGIN HISTORY **********//
	function get_client_exit() {
		$user_code = $this->session->userdata('user_code');
		$client_ip = $this->input->ip_address();
		$date_of_creation = date("Y-m-d h:i:s");
		$value = array(
			'user_code' => $user_code,
			'date_of_creation' => $date_of_creation,
			'client_ip' => $client_ip,
			'status' => '0',
			'action' => '0',
		);
		$this->db->insert('login_history_table', $value);
	}
	function get_client_start() {
		$user_code = $this->session->userdata('user_code');
		$client_ip = $this->input->ip_address();
		$date_of_creation = date("Y-m-d h:i:s");
		$value = array(
			'user_code' => $user_code,
			'date_of_creation' => $date_of_creation,
			'client_ip' => $client_ip,
			'status' => '1',
			'action' => '1',
		);
		$this->db->insert('login_history_table', $value);
	}

	function getCaptcha()
	{
		$im = @ImageCreate (80, 20) // Width and hieght of the image.
		or die ("Cannot Initialize new GD image stream");
		$background_color = ImageColorAllocate ($im, 204, 204, 204); // Assign background color
		$text_color = ImageColorAllocate ($im, 51, 51, 255);     // text color is given
		ImageString($im,5,8,2,$_SESSION['captcha'],$text_color); // Random string  from session added
		///im is the image source, Int 5 is the font size,Int 8 is the X position , Int 2
		ImagePng ($im); // image displayed
		imagedestroy($im); // Memory allocation for the image is removed.
	}

	function getReCaptcha()
	{
		if($this->session->has_userdata('captcha'))
		{
			$this->session->unset_userdata('captcha');
		}

		$pool = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
		$captcha = substr(str_shuffle(str_repeat($pool, 6)), 0, 6);
		$newdata = array(
			'captcha'  => $captcha
		);
		$this->session->set_userdata($newdata);



		$im = @ImageCreate (80, 20) // Width and hieght of the image.
		or die ("Cannot Initialize new GD image stream");

		$background_color = ImageColorAllocate ($im, 204, 204, 204); // Assign background color
		$text_color = ImageColorAllocate ($im, 51, 51, 255);      // text color is given
		ImageString($im,5,8,2,$_SESSION['captcha'],$text_color); // Random string  from session added
		///im is the image source, Int 5 is the font size,Int 8 is the X position , Int 2 is the Y position //

		ImagePng ($im); // image displayed
		imagedestroy($im); // Memory allocation for the image is removed.
	}
	//******* Check Captcha ********//
	function checkCaptcha($captcha)
	{
		if ($captcha == $this->session->userdata('captcha'))
		{
		  	return TRUE;
		}
		else
		{
			$this->form_validation->set_message('checkCaptcha', 'CAPTCHA does not match.');
			return FALSE;
		}
	}

	//********* Login Process ********//
	public function loginProcess()
	{
		$validation = array(
			array(
				'field' => 'uname',
				'label' => 'Username',
				'rules' => 'trim|required|xss_clean',
			),
			array(
				'field' => 'password',
				'label' => 'Password',
				'rules' => 'trim|required|xss_clean',
			),
			array(
				'field' => 'captcha',
				'label' => 'Captcha',
				'rules' => 'trim|required|xss_clean|callback_checkCaptcha',
			),
		);
		$data = array();
		$data['error'] = '';
		$this->form_validation->set_rules($validation);

		if ($this->form_validation->run() === FALSE) {
			$this->form_validation->set_error_delimiters('', '');
			foreach ($validation as $rule) {
				if (form_error($rule['field'])) {
					$data['error'] .= form_error($rule['field']).'<br>';
				}
			}
			$data['validation'] = false;
			echo json_encode($data);
			return;
		} else {
			$data['validation'] = true;

			$randomKey = $this->session->userdata('randomKey');

			$data['success'] = null;
			$user_name = $this->input->post('uname');
			$password = $this->input->post('password');

			// password format : sha512.update(hash + salt);
			$getPass = $this->db->query("SELECT password FROM depart_users WHERE 
				unique_user_id=?", array($user_name));

			if($getPass->num_rows()==0){
				$data['pass_success'] = false;
				echo json_encode($data);
				return;
			}
			$finalPassword = hash('sha512', ($getPass->row()->password.$randomKey));

			if($password == $finalPassword){
				$sql = "select * from depart_users where 
					unique_user_id=? and active_deactive=? and status=?";
				$res = $this->db->query($sql,array($user_name,'E','E'));
				if($res->num_rows() > 0){
					$row  = $res->row_array();
					$sessiondata = array(
						'name'  => $row['name'],
						'designation' 		=> $row['designation'],
						'date_of_joining'   => $row['date_of_joining'],
						'unique_user_id'    => $row['unique_user_id'],
						'first_login'     	=> $row['first_login'],
						'mobile_no'     	=> $row['mobile_no'],
						'email'     		=> $row['email'],
						'address'     		=> $row['address'],
						'user_code'     	=> $row['user_code'],
						'logged_in' 		=> TRUE
					);
					$this->session->set_userdata($sessiondata);
					$this->get_client_start();
					$data['success'] = true;
					echo json_encode($data);
					return;
				}else{
					$data['success'] = false;
					echo json_encode($data);
					return;
				}
			}
			else
			{
				$data['pass_success'] = false;
				echo json_encode($data);
				return;
			}			
		}
	}

	public function dbswitch($dist_code){
	    if($dist_code == "02"){
	        $this->db=$this->load->database('dhubri', TRUE);
	    } else if($dist_code == "05"){
	        $this->db=$this->load->database('barpeta', TRUE);
	    } else if($dist_code == "10"){
	        $this->db=$this->load->database('chirang', TRUE);
	    } else if($dist_code == "13"){
	        $this->db=$this->load->database('bongaigaon', TRUE);
	    }  else if($dist_code == "17"){
	        $this->db=$this->load->database('dibrugarh', TRUE);
	    }  else if($dist_code == "15"){
	        $this->db=$this->load->database('jorhat', TRUE);
	    }  else if($dist_code == "14"){
	        $this->db=$this->load->database('golaghat', TRUE);
	    }  else if($dist_code == "07"){
	        $this->db=$this->load->database('kamrup', TRUE);
	    }  else if($dist_code == "03"){
	        $this->db=$this->load->database('goalpara', TRUE);
	    }  else if($dist_code == "18"){
	        $this->db=$this->load->database('tinsukia', TRUE);
	    }  else if($dist_code == "12"){
	        $this->db=$this->load->database('lakhimpur', TRUE);
	    }  else if($dist_code == "24"){
	        $this->db=$this->load->database('kamrupm', TRUE);
	    }  else if($dist_code == "06"){
	        $this->db=$this->load->database('nalbari', TRUE);
	    }  else if($dist_code == "11"){
	        $this->db=$this->load->database('sonitpur', TRUE);
	    }  else if($dist_code == "16"){
	        $this->db=$this->load->database('sibsagar', TRUE);
	    }  else if($dist_code == "32"){
	        $this->db=$this->load->database('morigaon', TRUE);
	    }  else if($dist_code == "33"){
	        $this->db=$this->load->database('nagaon', TRUE);
	    }  else if($dist_code == "34"){
	        $this->db=$this->load->database('majuli', TRUE);
	    }  else if($dist_code == "21"){
	        $this->db=$this->load->database('karimganj', TRUE);
	    }  else if($dist_code == "35"){
	        $this->db=$this->load->database('biswanath', TRUE);
	    }  else if($dist_code == "36"){
	        $this->db=$this->load->database('hojai', TRUE);
	    }  else if($dist_code == "37"){
	        $this->db=$this->load->database('charaideo', TRUE);
	    }  else if($dist_code == "25"){
	        $this->db=$this->load->database('dhemaji', TRUE);
	    }  else if($dist_code == "39"){
	        $this->db=$this->load->database('bajali', TRUE);
	    }else if($dist_code == "38"){
	        $this->db=$this->load->database('ssalmara', TRUE);
	    }else if($dist_code == "08"){
	        $this->db=$this->load->database('darrang', TRUE);
	    }else if($dist_code == "auth"){
	        $this->db=$this->load->database('auth', TRUE);
	    }
	    return $this->db;
	}

	// ********** API for Dashboard ************//
    public function dashboardAPIPort()
    {
    	ini_set('memory_limit','-1');
    	set_time_limit(0);
		$dist_code = array();
		 $dist_code[] = '02'; ///dhubri
		 $dist_code[] = '03'; //goalpara
		 $dist_code[] = '05'; //barpeta
		 $dist_code[] = '06'; //nalbari
		 $dist_code[] = '07'; //kamrup
		 $dist_code[] = '08'; //darrang
		 $dist_code[] = '11'; //sonitpur
		 $dist_code[] = '12'; //lakhimpur
		 $dist_code[] = '13'; //bongaigaon
		 $dist_code[] = '14'; //golaghat
		 $dist_code[] = '15'; //jorhat
		 $dist_code[] = '16'; //sibsagar
		 $dist_code[] = '17'; //dibrugarh
		 $dist_code[] = '18'; //tinsukia
		 $dist_code[] = '21'; //karimganj
		 $dist_code[] = '24'; //kamrupM
		 $dist_code[] = '25'; //dhemaji
		 $dist_code[] = '32'; //morigaon
		 $dist_code[] = '33'; //nagaon
		 $dist_code[] = '34'; //majuli
		 $dist_code[] = '35'; //biswanath
		 $dist_code[] = '36'; //hojai
		 $dist_code[] = '37'; //charaideo
		 $dist_code[] = '38'; //south salmara
		 $dist_code[] = '39'; //bajali

        $total_state_dag = null;
        $total_state_patta = null;
		$total_state_pattadar = null;

        $total_state_land_class = null;
        $total_state_land_area = null;

        $total_state_dag_lessa = null;
		$total_state_dag_ganda = null;

		$total_state_annual_patta = null;
		$total_state_periodic_patta = null;

        $circle_wise_patta = array();
        $circle_wise_dag = array();

		$lot_wise_dag = array();
		$village_wise_dag = array();

        $total_state_zonal_dags = null;
		$total_state_zonal_village = null;

		$total_state_village = null;

        $bigha=$katha=$lessa=$ganda=$kranti=0;

        $c_bigha=$c_katha=$c_lessa=$c_ganda=$c_kranti=0;

        foreach ($dist_code as $d) {
            $this->dbswitch($d);
            $application_id = '01';
            echo $d;

            //******** Dag *********//

//            $sql = "select count(*) as dag, sum(dag_area_b) as bigha,
//            sum(dag_area_k) as katha,sum(dag_area_lc) as lessa,
//            sum(dag_area_g) as ganda,sum(dag_area_kr) as kranti
//            from chitha_basic";

			$sql = "select sum(cdp.dag_area_b) as bigha,
            sum(cdp.dag_area_k) as katha,sum(cdp.dag_area_lc) as lessa,
            sum(cdp.dag_area_g) as ganda,sum(cdp.dag_area_kr) as kranti,
            count(cdp.dag_no) as dag, count(cdp.dag_no) Filter (where l.rural_urban='U') as urban,
		    count(cdp.dag_no) Filter (where l.rural_urban='R') as rural,
		    count(cdp.dag_no) Filter (where l.rural_urban not in ('U','R')) as unmapped from 
		    chitha_basic cdp join location l on 
			cdp.dist_code=l.dist_code and cdp.subdiv_code=l.subdiv_code and cdp.cir_code=l.cir_code
			and cdp.mouza_pargona_code=l.mouza_pargona_code and cdp.lot_no=l.lot_no and 
			cdp.vill_townprt_code=l.vill_townprt_code";

            $res = $this->db->query($sql)->row_array();
            $total_state_dag = $total_state_dag + $res['dag'];
            $bigha = $res['bigha'];
            $katha = $res['katha'];
            $lessa = $res['lessa'];
            $ganda = $res['ganda'];
            $kranti = $res['kranti'];

            //*** total lessa ******//
            $total_district_dag_lessa = null;
			$total_district_dag_ganda = null;

			//********* 22.06.2022 *********//
            if(in_array($d, BARAK_VALLEY))
			{
				$total_district_dag_ganda = $this->utilityclass->barak_valley_total_ganda($bigha,$katha,$lessa,$ganda);
				$total_district_dag_ganda_covert = $this->utilityclass->barak_valley_total_bigha_katha_lessa_ganda($total_district_dag_ganda);
				$total_state_dag_ganda = $total_state_dag_ganda + $total_district_dag_ganda;
			}else{
				$total_district_dag_lessa = $this->utilityclass->brahmaputra_valley_total_lessa($bigha,$katha,$lessa);
				$total_district_dag_lessa_covert = $this->utilityclass->brahmaputra_valley_total_bigha_katha_lessa($total_district_dag_lessa);
				$total_state_dag_lessa = $total_state_dag_lessa + $total_district_dag_lessa;
			}

			//********* 22.06.2022 *********//
			//*** Pattadar District wise ***//
			$sql6 = "Select count(*) as pattadar from chitha_dag_pattadar cdp where 
					(cdp.p_flag!='1' or cdp.p_flag is null)";
			$res6 = $this->db->query($sql6)->row_array();
			$total_state_pattadar = $total_state_pattadar + $res6['pattadar'];

			if(in_array($d, BARAK_VALLEY))
			{
				$district_wise_dag_array = array();
				$district_wise_dag_array['district_code'] = $d;
				$district_wise_dag_array['district_wise_dag'] = $res['dag'];
				$district_wise_dag_array['district_rural_dag'] = $res['rural'];
				$district_wise_dag_array['district_urban_dag'] = $res['urban'];
				$district_wise_dag_array['district_unmapped_dag'] = $res['unmapped'];
				$district_wise_dag_array['district_wise_dag_area_bigha'] = $total_district_dag_ganda_covert[0];
				$district_wise_dag_array['district_wise_dag_area_katha'] =  $total_district_dag_ganda_covert[1];
				$district_wise_dag_array['district_wise_dag_area_lessa'] =  $total_district_dag_ganda_covert[2];
				$district_wise_dag_array['district_wise_dag_area_ganda'] = $total_district_dag_ganda_covert[3];
				$district_wise_dag_array['district_wise_dag_area_kranti'] = $res['kranti'];
				$district_wise_dag_array['district_wise_pattadar'] = $res6['pattadar'];
			}else{
				$district_wise_dag_array = array();
				$district_wise_dag_array['district_code'] = $d;
				$district_wise_dag_array['district_wise_dag'] = $res['dag'];
				$district_wise_dag_array['district_rural_dag'] = $res['rural'];
				$district_wise_dag_array['district_urban_dag'] = $res['urban'];
				$district_wise_dag_array['district_unmapped_dag'] = $res['unmapped'];
				$district_wise_dag_array['district_wise_dag_area_bigha'] = $total_district_dag_lessa_covert[0];
				$district_wise_dag_array['district_wise_dag_area_katha'] =  $total_district_dag_lessa_covert[1];
				$district_wise_dag_array['district_wise_dag_area_lessa'] =  $total_district_dag_lessa_covert[2];
				$district_wise_dag_array['district_wise_dag_area_ganda'] = $res['ganda'];
				$district_wise_dag_array['district_wise_dag_area_kranti'] = $res['kranti'];
				$district_wise_dag_array['district_wise_pattadar'] = $res6['pattadar'];
			}

            //*********** get dag chitha details upto circle *************//

//            $sql5 = "select count(*) as dag, sum(dag_area_b) as bigha,
//            sum(dag_area_k) as katha,sum(dag_area_lc) as lessa,
//            sum(dag_area_g) as ganda,sum(dag_area_kr) as kranti,
//                    dist_code,subdiv_code,cir_code from
//                    chitha_basic group by dist_code,subdiv_code,cir_code";

			$sql5 = "select cdp.dist_code,cdp.subdiv_code, cdp.cir_code, sum(cdp.dag_area_b) as bigha,
            sum(cdp.dag_area_k) as katha,sum(cdp.dag_area_lc) as lessa,
            sum(cdp.dag_area_g) as ganda,sum(cdp.dag_area_kr) as kranti,
            count(cdp.dag_no) as dag, count(cdp.dag_no) Filter (where l.rural_urban='U') as urban,
		    count(cdp.dag_no) Filter (where l.rural_urban='R') as rural,
		    count(cdp.dag_no) Filter (where l.rural_urban not in ('U','R')) as unmapped from 
		    chitha_basic cdp join location l on 
			cdp.dist_code=l.dist_code and cdp.subdiv_code=l.subdiv_code and cdp.cir_code=l.cir_code
			and cdp.mouza_pargona_code=l.mouza_pargona_code and cdp.lot_no=l.lot_no and 
			cdp.vill_townprt_code=l.vill_townprt_code group by cdp.dist_code,cdp.subdiv_code,
			cdp.cir_code";
            $circle_wise_dag['dag'] = $this->db->query($sql5)->result_array();

            /******* 08.07.2022 **********/
			//*********** get dag chitha lot wise *************//
//			$sql36 = "select count(*) as dag, sum(dag_area_b) as bigha,
//            sum(dag_area_k) as katha,sum(dag_area_lc) as lessa,
//            sum(dag_area_g) as ganda,sum(dag_area_kr) as kranti,
//                    dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no from
//                    chitha_basic group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no";

			$sql36 = "select cdp.dist_code,cdp.subdiv_code, cdp.cir_code,cdp.mouza_pargona_code,cdp.lot_no,
 			sum(cdp.dag_area_b) as bigha,
            sum(cdp.dag_area_k) as katha,sum(cdp.dag_area_lc) as lessa,
            sum(cdp.dag_area_g) as ganda,sum(cdp.dag_area_kr) as kranti,
            count(cdp.dag_no) as dag, count(cdp.dag_no) Filter (where l.rural_urban='U') as urban,
		    count(cdp.dag_no) Filter (where l.rural_urban='R') as rural,
		    count(cdp.dag_no) Filter (where l.rural_urban not in ('U','R')) as unmapped from 
		    chitha_basic cdp join location l on 
			cdp.dist_code=l.dist_code and cdp.subdiv_code=l.subdiv_code and cdp.cir_code=l.cir_code
			and cdp.mouza_pargona_code=l.mouza_pargona_code and cdp.lot_no=l.lot_no and 
			cdp.vill_townprt_code=l.vill_townprt_code group by cdp.dist_code,cdp.subdiv_code,
			cdp.cir_code,cdp.mouza_pargona_code,cdp.lot_no";
			$dag_lot_wise = $this->db->query($sql36)->result_array();

			foreach ($dag_lot_wise as $lot)
			{
				$lot_wise_dag['dag'][$d.'-'.$lot['subdiv_code'].'-'.$lot['cir_code']][] = $lot;
			}

			//*********** get dag chitha Village wise *************//
//			$sql37 = "select count(*) as dag, sum(dag_area_b) as bigha,
//            sum(dag_area_k) as katha,sum(dag_area_lc) as lessa,
//            sum(dag_area_g) as ganda,sum(dag_area_kr) as kranti,
//                    dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,vill_townprt_code from
//                    chitha_basic group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,vill_townprt_code";

			$sql37 = "select cdp.dist_code,cdp.subdiv_code, cdp.cir_code,
			cdp.mouza_pargona_code,cdp.lot_no,cdp.vill_townprt_code,
 			sum(cdp.dag_area_b) as bigha,
            sum(cdp.dag_area_k) as katha,sum(cdp.dag_area_lc) as lessa,
            sum(cdp.dag_area_g) as ganda,sum(cdp.dag_area_kr) as kranti,
            count(cdp.dag_no) as dag, count(cdp.dag_no) Filter (where l.rural_urban='U') as urban,
		    count(cdp.dag_no) Filter (where l.rural_urban='R') as rural,
		    count(cdp.dag_no) Filter (where l.rural_urban not in ('U','R')) as unmapped from 
		    chitha_basic cdp join location l on 
			cdp.dist_code=l.dist_code and cdp.subdiv_code=l.subdiv_code and cdp.cir_code=l.cir_code
			and cdp.mouza_pargona_code=l.mouza_pargona_code and cdp.lot_no=l.lot_no and 
			cdp.vill_townprt_code=l.vill_townprt_code group by cdp.dist_code,cdp.subdiv_code,
			cdp.cir_code,cdp.mouza_pargona_code,cdp.lot_no,cdp.vill_townprt_code";

			$dag_village_wise = $this->db->query($sql37)->result_array();

			foreach ($dag_village_wise as $vill)
			{
				$village_wise_dag['dag'][$d.'-'.$vill['subdiv_code'].'-'.$vill['cir_code'].'-'.$vill['mouza_pargona_code'].'-'.$vill['lot_no']][] = $vill;
			}

            //******** Patta *********//
            $sql2="Select count(t.countpatta_no) as totalpatta from
                    (Select count(distinct(patta_no) ) as countpatta_no from chitha_basic
                    where patta_type_code  in (select type_code from patta_code where jamabandi='y')
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) as t ";
            $totalPatta=$this->db->query($sql2)->row_array();
            $total_state_patta = $total_state_patta + $totalPatta['totalpatta'];

            $district_patta_array = array();
            $district_patta_array['district_code'] = $d;
            $district_patta_array['district_wise_patta'] = $totalPatta['totalpatta'];
			if(in_array($d, BARAK_VALLEY)) {
				$district_wise_array_merge['barak_valley'][$application_id . $d] = array_merge($district_wise_dag_array, $district_patta_array);
			}else{
				$district_wise_array_merge['brahmaputra_valley'][$application_id . $d] = array_merge($district_wise_dag_array, $district_patta_array);
			}

			//********* 27.06.2022 *********//
			//****** patta Type wise ***********//
			$Patta_type_wise = null;
			$sql8="Select count(t.countpatta_no) as totalpatta,t.patta_type,t.dist_code from
                    (Select count(distinct(patta_no)) as countpatta_no, patta_type_code as patta_type,
                    dist_code
                    from chitha_basic
                    where patta_type_code in (select type_code from patta_code where jamabandi='y')
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) as t GROUP BY t.patta_type,t.dist_code";
			$Patta_type_wise=$this->db->query($sql8)->result_array();

			$district_wise_array_merge['patta_type_district_wise'][$application_id . $d] = $Patta_type_wise;

			//****** Patta Type Circle Wise ***********//
			$Patta_type_circle_wise = null;
			$sql9="Select count(t.countpatta_no) as totalpatta,t.patta_type,t.dist_code,t.subdiv_code,t.cir_code from
                    (Select count(distinct(patta_no)) as countpatta_no, patta_type_code as patta_type,
                    dist_code,subdiv_code,cir_code
                    from chitha_basic
                    where patta_type_code in (select type_code from patta_code where jamabandi='y')
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) as t GROUP BY t.patta_type,t.dist_code,
               t.subdiv_code,t.cir_code order by t.subdiv_code ASC,t.cir_code ASC";
			$Patta_type_circle_wise=$this->db->query($sql9)->result_array();

			$circle_wise_patta['patta_type_circle_wise'] = $Patta_type_circle_wise;

			//*** annual patta District wise ***//
			$sql10 = "Select count(t.countpatta_no) as totalpatta,t.patta_type,t.dist_code from 
					(Select count(distinct(patta_no) ) as countpatta_no, patta_type_code as patta_type,
                    dist_code from 
					chitha_basic  where patta_type_code in (select type_code from patta_code where
					 apcancellation='y')
					group by dist_code,subdiv_code,cir_code,
					mouza_pargona_code,lot_no,vill_townprt_code,patta_no,patta_type_code ) as t 
					GROUP BY t.patta_type,t.dist_code";
			$annual_patta = $this->db->query($sql10)->result_array();

			foreach ($annual_patta as $ap)
			{
				$total_state_annual_patta = $total_state_annual_patta + $ap['totalpatta'];
			}

			$district_wise_array_merge['annual_patta_district_wise'][$application_id . $d] =  $annual_patta;

			//*** periodic patta District wise ***//
			$sql10 = "Select count(t.countpatta_no) as totalpatta,t.patta_type,t.dist_code from 
					(Select count(distinct(patta_no) ) as countpatta_no,patta_type_code as patta_type,
                    dist_code from 
					chitha_basic  where patta_type_code in (select type_code from  patta_code where 
					jamabandi='y' and apcancellation is null)
					group by dist_code,subdiv_code,cir_code,
					mouza_pargona_code,lot_no,vill_townprt_code,patta_no,patta_type_code ) as t
					GROUP BY t.patta_type,t.dist_code";
			$periodic_patta = $this->db->query($sql10)->result_array();

			foreach ($periodic_patta as $pp)
			{
				$total_state_periodic_patta = $total_state_periodic_patta + $pp['totalpatta'];
			}

			$district_wise_array_merge['periodic_patta_district_wise'][$application_id . $d] =  $periodic_patta;

            //*********** get patta chitha details upto circle *************//
            $sql4 = "Select count(t.patta_no) as totalpatta,t.dist_code,t.subdiv_code,t.cir_code from
                    (Select count(distinct(patta_no))  as patta_no,dist_code,subdiv_code,cir_code from chitha_basic
                    where patta_type_code  in (select type_code from patta_code where jamabandi=?)
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) AS t  GROUP BY t.dist_code,t.subdiv_code,t.cir_code";
            $circle_wise_patta['patta'] = $this->db->query($sql4,array('y'))->result_array();

			//********* 28.06.2022 *********//
			//*********** get annual patta circle wise *************//
			$sql11 = "Select count(t.patta_no) as totalpatta,t.patta_type,t.dist_code,t.subdiv_code,t.cir_code from
                    (Select count(distinct(patta_no))  as patta_no,patta_type_code as patta_type,
                    dist_code,subdiv_code,cir_code from chitha_basic
                    where patta_type_code  in (select type_code from patta_code where
					 apcancellation='y')
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) AS t  GROUP BY t.patta_type,
               t.dist_code,t.subdiv_code,t.cir_code order by t.subdiv_code ASC,t.cir_code ASC";
			$circle_wise_patta['annual-patta'] = $this->db->query($sql11)->result_array();

			//*********** get periodic patta circle wise *************//
			$sql12 = "Select count(t.patta_no) as totalpatta,t.patta_type,t.dist_code,t.subdiv_code,t.cir_code from
                    (Select count(distinct(patta_no))  as patta_no,patta_type_code as patta_type,
                    dist_code,subdiv_code,cir_code from chitha_basic
                    where patta_type_code  in (select type_code from  patta_code where 
					jamabandi='y' and apcancellation is null)
               group by dist_code,subdiv_code,cir_code,mouza_pargona_code,lot_no,
               vill_townprt_code,patta_no,patta_type_code ) AS t  GROUP BY t.patta_type,
               t.dist_code,t.subdiv_code,t.cir_code order by t.subdiv_code ASC,t.cir_code ASC";
			$circle_wise_patta['periodic-patta'] = $this->db->query($sql12)->result_array();

            //********* 22.06.2022 *********//
			//******* Pattadar circle wise ***********//
			$sql7 = "Select count(*) as pattadar,dist_code,subdiv_code,cir_code from chitha_dag_pattadar cdp where 
			(cdp.p_flag!='1' or cdp.p_flag is null) group by dist_code,subdiv_code,cir_code";
			$circle_wise_pattadar['pattadar'] = $this->db->query($sql7)->result_array();

			/********* Zonal Value *****************/
			//CIRCLE WISE
			$sql21 = "select subdiv_code,cir_code from location where subdiv_code!=? 
					and cir_code!=? and mouza_pargona_code=?
                    and lot_no=? and vill_townprt_code=?";
			$res21 = $this->db->query($sql21,array('00','00','00','00','00000'))->result_array();
			$zonal_dag_cir_count = array();
			$zonal_village_cir_count = array();
			foreach($res21 as $r21)
			{
				$sql22 = "Select count(*) as c from dagwise_zone_info where 
					subdiv_code=? and cir_code=? and mouza_pargona_code!=?
                    and lot_no!=? and vill_code!=?";
				$count22 = $this->db->query($sql22,array($r21['subdiv_code'],$r21['cir_code'],'00','00','00000'))->row()->c;

				$sql23 = "Select count(*) as c from chitha_basic where 
				subdiv_code=? and cir_code=? and mouza_pargona_code!=?
                    and lot_no!=? and vill_townprt_code!=?";
				$count23 = $this->db->query($sql23,array($r21['subdiv_code'],$r21['cir_code'],'00','00','00000'))->row()->c;

				$circle_wise_zonal_dag_array = array();
				$circle_wise_zonal_dag_array['district_code'] = $d;
				$circle_wise_zonal_dag_array['subdiv_code'] = $r21['subdiv_code'];
				$circle_wise_zonal_dag_array['cir_code'] = $r21['cir_code'];
				$circle_wise_zonal_dag_array['zonal_dags'] = $count22;
				$circle_wise_zonal_dag_array['chitha_dags'] = $count23;
				$circle_wise_zonal_dag_array['pending_dags'] = $count23-$count22;

				$zonal_dag_cir_count['zonal_dag_cir_count'][] = $circle_wise_zonal_dag_array;


				$sql30 = "Select count(DISTINCT unique_village_code) as c from villagewise_zone_info 
					where subdiv_code=? and cir_code=? and mouza_pargona_code!=?
                    and lot_no!=? and vill_code!=?";
				$count30 = $this->db->query($sql30, array($r21['subdiv_code'], $r21['cir_code'],'00','00','00000'))->row()->c;

				$sql31 = "Select count(DISTINCT uuid) as c from location where 
					subdiv_code=? and cir_code=? and mouza_pargona_code!=?
                    and lot_no!=? and vill_townprt_code!=?";
				$count31 = $this->db->query($sql31,array($r21['subdiv_code'],$r21['cir_code'],'00','00','00000'))->row()->c;

				$circle_wise_zonal_village_array = array();
				$circle_wise_zonal_village_array['district_code'] = $d;
				$circle_wise_zonal_village_array['subdiv_code'] = $r21['subdiv_code'];
				$circle_wise_zonal_village_array['cir_code'] = $r21['cir_code'];
				$circle_wise_zonal_village_array['zonal_village'] = $count30;
				$circle_wise_zonal_village_array['chitha_village'] = $count31;
				$circle_wise_zonal_village_array['remaining_village'] = $count31-$count30;

				$zonal_village_cir_count['zonal_village_cir_count'][] = $circle_wise_zonal_village_array;
			}

//			$sql32 = "select subdiv_code,cir_code from location where subdiv_code!=?
//					and cir_code!=? and mouza_pargona_code=?
//                    and lot_no=? and vill_townprt_code=?";
//			$res32 = $this->db->query($sql32,array('00','00','00','00','00000'))->result_array();
//			$zonal_village_cir_count = array();
//			foreach($res32 as $r32) {
//				$sql30 = "Select count(DISTINCT unique_village_code) as c from villagewise_zone_info
//					where subdiv_code=? and cir_code=?";
//				$count30 = $this->db->query($sql30, array($r32['subdiv_code'], $r32['cir_code']))->row()->c;
//
//				$sql31 = "Select count(DISTINCT uuid) as c from location where subdiv_code=? and cir_code=?";
//				$count31 = $this->db->query($sql31,array($r32['subdiv_code'],$r32['cir_code']))->row()->c;
//
//				$circle_wise_zonal_village_array = array();
//				$circle_wise_zonal_village_array['district_code'] = $d;
//				$circle_wise_zonal_village_array['subdiv_code'] = $r32['subdiv_code'];
//				$circle_wise_zonal_village_array['cir_code'] = $r32['cir_code'];
//				$circle_wise_zonal_village_array['zonal_village'] = $count30;
//				$circle_wise_zonal_village_array['chitha_village'] = $count31;
//				$circle_wise_zonal_village_array['remaining_village'] = $count31-$count30;
//
//				$zonal_village_cir_count['zonal_village_cir_count'][] = $circle_wise_zonal_village_array;
//			}

			//***** merge circle wise array *********//
            $circle_wise_array_merge[$application_id.$d] = array_merge($circle_wise_dag,$circle_wise_patta,$circle_wise_pattadar,$zonal_dag_cir_count,$zonal_village_cir_count);

			//***** merge lot wise array *********//
			$lot_wise_array_merge[$application_id.$d] = $lot_wise_dag;

			/********* Zonal Value *****************/
			//VILLAGE WISE
			$sql24 = "select * from location where subdiv_code!=? and 
					cir_code!=? and mouza_pargona_code!=?
                    and lot_no!=? and vill_townprt_code!=?
                    order by subdiv_code,cir_code,mouza_pargona_code,lot_no,vill_townprt_code";
			$res24 = $this->db->query($sql24,array('00','00','00','00','00000'))->result_array();
			foreach($res24 as $r24)
			{
				$sql25 = "Select count(*) as c from dagwise_zone_info where unique_village_code=?";
				$count25 = $this->db->query($sql25,array($r24['uuid']))->row()->c;

				$sql33= "Select count(*) as c from dagwise_zone_info where unique_village_code=? and flag=?";
				$count33 = $this->db->query($sql33,array($r24['uuid'],'1'))->row()->c;

				$sql26 = "Select count(*) as c from chitha_basic where subdiv_code=? 
					and cir_code=? and mouza_pargona_code=?
                    and lot_no=? and vill_townprt_code=?";
				$count26 = $this->db->query($sql26,array($r24['subdiv_code'],$r24['cir_code'],
					$r24['mouza_pargona_code'],$r24['lot_no'],$r24['vill_townprt_code']))->row()->c;

				$vill_wise_zonal_dag_array = array();
				$vill_wise_zonal_dag_array['district_code'] = $d;
				$vill_wise_zonal_dag_array['subdiv_code'] = $r24['subdiv_code'];
				$vill_wise_zonal_dag_array['cir_code'] = $r24['cir_code'];
				$vill_wise_zonal_dag_array['mouza_pargona_code'] = $r24['mouza_pargona_code'];
				$vill_wise_zonal_dag_array['lot_no'] = $r24['lot_no'];
				$vill_wise_zonal_dag_array['vill_townprt_code'] = $r24['vill_townprt_code'];
				$vill_wise_zonal_dag_array['uuid'] = $r24['uuid'];
				$vill_wise_zonal_dag_array['zonal_dags'] = $count25;
				$vill_wise_zonal_dag_array['chitha_dags'] = $count26;
				$vill_wise_zonal_dag_array['pending_dags'] = $count26-$count25;
				$vill_wise_zonal_dag_array['approve_dags'] = $count33;

				$zonal_vill_count['zonal_dag_count'][$d.'-'.$r24['subdiv_code'].'-'.$r24['cir_code']][] = $vill_wise_zonal_dag_array;

				$sql29 = "Select count(DISTINCT unique_village_code) as c from villagewise_zone_info 
						where unique_village_code=?";
				$count29 = $this->db->query($sql29,array($r24['uuid']))->row()->c;

				$sql34 = "Select count(*) as c from villagewise_zone_info 
						where unique_village_code=? and flag=?";
				$flag34 = $this->db->query($sql34,array($r24['uuid'],'1'))->row()->c;

				$vill_wise_zonal_village_array = array();
				$vill_wise_zonal_village_array['district_code'] = $d;
				$vill_wise_zonal_village_array['subdiv_code'] = $r24['subdiv_code'];
				$vill_wise_zonal_village_array['cir_code'] = $r24['cir_code'];
				$vill_wise_zonal_village_array['mouza_pargona_code'] = $r24['mouza_pargona_code'];
				$vill_wise_zonal_village_array['lot_no'] = $r24['lot_no'];
				$vill_wise_zonal_village_array['vill_townprt_code'] = $r24['vill_townprt_code'];
				$vill_wise_zonal_village_array['uuid'] = $r24['uuid'];
				$vill_wise_zonal_village_array['zonal_village'] = $count29;
				$vill_wise_zonal_village_array['zonal_village_flag'] = $flag34;

				$zonal_vill_count['zonal_vill_count'][$d.'-'.$r24['subdiv_code'].'-'.$r24['cir_code']][] = $vill_wise_zonal_village_array;
			}

			//total village
			$total_state_village = $total_state_village + sizeof($res24);

			//merge village data
			$village_wise_array_merge[$application_id.$d] = array_merge($zonal_vill_count,$village_wise_dag);

			//district wise
			$sql27 = "Select count(*) as c from dagwise_zone_info";
			$count27 = $this->db->query($sql27)->row()->c;

			$sql28 = "Select count(DISTINCT unique_village_code) as c from villagewise_zone_info";
			$count28 = $this->db->query($sql28)->row()->c;

			$district_wise_zonal_dag_array = array();
			$district_wise_zonal_dag_array['district_code'] = $d;
			$district_wise_zonal_dag_array['zonal_dags'] = $count27;
			$district_wise_zonal_dag_array['chitha_dags'] = $res['dag'];
			$district_wise_zonal_dag_array['pending_dags'] = $res['dag']-$count27;

			$district_wise_zonal_village_array = array();
			$district_wise_zonal_village_array['district_code'] = $d;
			$district_wise_zonal_village_array['zonal_village'] = $count28;
			$district_wise_zonal_village_array['total_village'] = sizeof($res24);
			$district_wise_zonal_village_array['pending_village'] = sizeof($res24)-$count28;

			$district_wise_array_merge['zonal-dag'][$application_id . $d] = $district_wise_zonal_dag_array;

			$district_wise_array_merge['zonal-village'][$application_id . $d] = $district_wise_zonal_village_array;

			$total_state_zonal_village = $total_state_zonal_village + $count28;
			$total_state_zonal_dags = $total_state_zonal_dags + $count27;
        }
        $total_state_area_brahmaputra_conver = $this->utilityclass->brahmaputra_valley_total_bigha_katha_lessa($total_state_dag_lessa);
		$total_state_area_barak_valley_conver = $this->utilityclass->barak_valley_total_bigha_katha_lessa_ganda($total_state_dag_ganda);

        //**** State Wise Dag *****//
        $total_state_array = array();
        $total_state_array['total_state_dag'] = $total_state_dag;
        $total_state_array['brahmaputra_valley']['total_state_area_bigha'] = $total_state_area_brahmaputra_conver[0];
        $total_state_array['brahmaputra_valley']['total_state_area_katha'] = $total_state_area_brahmaputra_conver[1];
        $total_state_array['brahmaputra_valley']['total_state_area_lessa'] = $total_state_area_brahmaputra_conver[2];

        $total_state_array['barak_valley']['total_state_area_bigha'] = $total_state_area_barak_valley_conver[0];
		$total_state_array['barak_valley']['total_state_area_katha'] = $total_state_area_barak_valley_conver[1];
		$total_state_array['barak_valley']['total_state_area_lessa'] = $total_state_area_barak_valley_conver[2];
		$total_state_array['barak_valley']['total_state_area_ganda'] = $total_state_area_barak_valley_conver[3];

		$total_state_array['total_state_pattadar'] = $total_state_pattadar;
		$total_state_array['total_state_annual_patta'] = $total_state_annual_patta;
		$total_state_array['total_state_periodic_patta'] = $total_state_periodic_patta;
		$total_state_array['total_state_patta'] = $total_state_patta;
		$total_state_array['total_zonal_dags'] = $total_state_zonal_dags;
		$total_state_array['total_zonal_village'] = $total_state_zonal_village;

        //**** State Wise Patta *****//
//        $total_state_patta_array = array();
//        $total_state_patta_array['total_state_patta'] = $total_state_patta;

        $json = array();
        //***** DAG & PATTA *****//
//        $json['total_state'] = array_merge($total_state_array,$total_state_patta_array);
		$json['total_state'] = $total_state_array;
        $json['district_wise']= $district_wise_array_merge;
        $json['circle_wise'] = $circle_wise_array_merge;
		$json['lot_wise'] = $lot_wise_array_merge;
		$json['village_wise'] = $village_wise_array_merge;

        $state_wise = json_encode($json['total_state']);
	    $district_wise = json_encode($json['district_wise']);
	    $cirlce_wise = json_encode($json['circle_wise']);
		$lot_wise = json_encode($json['lot_wise']);
		$village_wise = json_encode($json['village_wise']);


		//insert into table ilrms_dashboard_records
		$insertIntoMisDagCount = [
			'application_id' => DHARITREE,
			'statewise_json' => $state_wise,
			'districtwise_json' => $district_wise,
			'circlewise_json' => $cirlce_wise,
			'lotwise_json' => $lot_wise,
			'villagewise_json' => $village_wise,
			// 'lotwise_json' => $lot_data,
			// 'villagewise_json' => $vill_data,
			// 'pending_with_dc_json' => $pending_with_dc,
			// 'pending_with_adc_json' => $pending_with_dc,
			// 'pending_with_co_json' => $pending_with_co,
			// 'pending_with_lm_json' => null,
			// 'pending_with_sk_json' => null,
			// 'pending_with_ast_json' => null,
			'created_at' => date('Y-m-d h:i:s'),
		];

		//var_dump($insertIntoMisDagCount);return;
		$this->db = $this->load->database('db2',TRUE);
                $this->db->trans_begin();
		$ins1 = $this->db->query('delete from ilrms_dashboard_records');
//		if($this->db->affected_rows() != 1)
//		{
//			$this->db->trans_rollback();
//			echo 'Unable to delete data.';
//			return;
//		}

		$ins = $this->db->insert('ilrms_dashboard_records', $insertIntoMisDagCount);
                if ($ins >0)
                {
                   $this->db->trans_commit();
		   echo 'gg: '.$ins;
                }
                else
                {
                   $this->db->trans_rollback();
		   echo 'Failed Druna';
                }
    }

//    function Total_Lessa($bigha, $katha, $lessa) {
//        $total_lessa = $lessa + ($katha * 20) + ($bigha * 100);
//        return $total_lessa;
//    }
//
//    function Total_Bigha_Katha_Lessa($total_lessa) {
//        $bigha = $total_lessa / 100;
//        $rem_lessa = fmod($total_lessa, 100);
//        $katha = $rem_lessa / 20;
//        $r_lessa = fmod($rem_lessa, 20);
//        $mesaure = array();
//        $mesaure[].=floor($bigha);
//        $mesaure[].=floor($katha);
//        $mesaure[].=$r_lessa;
//        return $mesaure;
//    }
//
//    //for barak valley
//    function Total_ganda($bigha, $katha, $lessa,$ganda){
//		$total_ganda = ($bigha * 6400) + ($katha * 320) + ($lessa * 20) + $ganda;
//		return $total_ganda;
//	}
//
//	function Total_Bigha_Katha_Lessa_Ganda_Kranti($total_ganda)
//	{
//		$bigha = $total_ganda / 6400;
//		$rem_ganda = fmod($total_ganda, 6400);
//		$katha = $rem_ganda/ 320;
//		$r_ganda = fmod($rem_ganda, 320);
//		$lessa = $r_ganda / 20;
//		$ganda = fmod($r_ganda, 20);
//		$mesaure = array();
//		$mesaure[].=floor($bigha);
//		$mesaure[].=floor($katha);
//		$mesaure[].=floor($lessa);
//		$mesaure[].=$ganda;
//		return $mesaure;
//	}

 //    function dashboardAPICurl(){
	//     //$url = 'http://localhost/ilrmsdashboard/dashboard-api';
	//     $url = base_url().'dashboard-api';
	//     $ch = curl_init();
	//     curl_setopt($ch, CURLOPT_URL, $url);
	//     curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
	//     curl_setopt($ch, CURLOPT_SSL_VERIFYHOST,  2);
	//     curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
	//     $output = curl_exec($ch);
	//     $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
	//     curl_close($ch);
	//     $data = json_decode($output);

	//     $state_wise = json_encode($data->total_state);
	//     $district_wise = json_encode($data->district_wise);
	//     $cirlce_wise = json_encode($data->circle_wise);

	// 	//insert into table ilrms_dashboard_records
	// 	$insertIntoMisDagCount = [
	// 		'application_id' => DHARITREE,
	// 		'statewise_json' => $state_wise,
	// 		'districtwise_json' => $district_wise,
	// 		'circlewise_json' => $cirlce_wise,
	// 		// 'lotwise_json' => $lot_data,
	// 		// 'villagewise_json' => $vill_data,
	// 		// 'pending_with_dc_json' => $pending_with_dc,
	// 		// 'pending_with_adc_json' => $pending_with_dc,
	// 		// 'pending_with_co_json' => $pending_with_co,
	// 		// 'pending_with_lm_json' => null,
	// 		// 'pending_with_sk_json' => null,
	// 		// 'pending_with_ast_json' => null,
	// 		'created_at' => date('Y-m-d h:i:s'),
	// 	];
	// 	$ins = $this->db->insert('ilrms_dashboard_records', $insertIntoMisDagCount);
	    
	// }



       public function backup_json(){
		$sqlBak = "Select * from ilrms_dashboard_records order by id DESC";
		$result = $this->db->query($sqlBak)->row();

		$json = json_encode([
			"id" => $result->id,
			"statewise_json" => json_decode($result->statewise_json),
			"districtwise_json" => json_decode($result->districtwise_json),
			"circlewise_json" => json_decode($result->circlewise_json),
			"lotwise_json" => json_decode($result->lotwise_json),
			"villagewise_json" => json_decode($result->villagewise_json),
			"pending_with_dc_json" => json_decode($result->pending_with_dc_json),
			"pending_with_adc_json" => json_decode($result->pending_with_adc_json),
			"pending_with_co_json" => json_decode($result->pending_with_co_json),
			"pending_with_lm_json" => json_decode($result->pending_with_lm_json),
			"pending_with_sk_json" => json_decode($result->pending_with_sk_json),
			"pending_with_ast_json" => json_decode($result->pending_with_ast_json),
			"created_at" => json_decode($result->created_at),
		]);

		file_put_contents(BACKUP_JSON_DIR.'ilrms_dashboard_data_'.date("Y-m-d-H-i-s").'.json', $json);
		echo "********************<br>";
		echo "File Write Complete<br>";
		echo "File name is ". BACKUP_JSON_DIR.'ilrms_dashboard_data_'.date("Y-m-d-H-i-s").'.json<br>';
		echo "********************<br>";
		exit;
	}



}
